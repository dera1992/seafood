{% extends "base_admin.html" %}
{% load static %}
{% load django_bootstrap5 %}
{% load i18n %}

{% block title %}Submite your property{% endblock %}

{% block content %}
    <div class="container-fluid">
      <!-- ============================================================== -->
      <!-- Bread crumb and right sidebar toggle -->
      <!-- ============================================================== -->
      <div class="row page-titles">
        <div class="col-6 align-self-center">
          <h3>Add/Edit Products</h3>
        </div>
        <div class="col-6 text-right font-12"> <a href="{% url 'home:home' %}">Home</a>  &gt; Add Products</div>
        <div class="">
          <button class="right-side-toggle waves-effect waves-light bg-primary btn btn-circle btn-sm pull-right ml-10"><i class="ti-settings text-white"></i></button>
        </div>
      </div>

      <!-- ============================================================== -->
      <!-- Start Page Content -->
      <!-- ============================================================== -->
      <div class="row">
        <div class="col-lg-12 col-md-12">
          <div class="card">
            <div class="card-body">
              <h4> General </h4>
              <div class="row mb-3">
                <div class="col-md-6 col-xs-12 mb-10">
                  <label for="templateProduct" class="font-14">Use an existing product as a template</label>
                  <select id="templateProduct" class="form-control font-14">
                    <option value="">Select a product template</option>
                    {% for template_product in template_products %}
                      <option value="{{ template_product.id }}">{{ template_product.title }}</option>
                    {% endfor %}
                  </select>
                </div>
                <div class="col-md-6 col-xs-12 mb-10 text-right">
                  <a class="btn btn-outline-primary btn-sm mt-4" href="{% url 'foodcreate:bulk_upload_products' %}">
                    Bulk upload products
                  </a>
                </div>
              </div>
              <div class="progress mb-4" style="height: 8px;">
                <div id="onboardingProgress" class="progress-bar bg-success" role="progressbar" style="width: 0%"></div>
              </div>
              <div class="row">
                <div class="form-wrap form-wrap2 col-12">
                  <form class="form-horizontal"  id="post_form" method="post" data-cities-url="{% url 'foodcreate:ajax_load_subcategories' %}" action="." enctype="multipart/form-data" data-existing-images="{% if product %}{{ product.images.count }}{% else %}0{% endif %}">
                  {% csrf_token %}
                    <div>
                      <div class="form-group">
                        <div >
                            {% bootstrap_field postForm.title %}
{#                          <input type="email" class="form-control font-14"  placeholder="Name">#}
                        </div>
                      </div>
                    </div>
                    <div class="clearfix"></div>
                    <div class="form-group">
                      <div class="row">
                        <div class="col-sm-6 col-xs-12 mb-10">
                          <div>
                              {% bootstrap_field postForm.category %}
                          </div>
                        </div>
                        <div class="col-md-6 col-xs-12 mb-10">
                          <div >
                              {% bootstrap_field postForm.subcategory %}
                          </div>
                        </div>
                      </div>
                    </div>
                    <div class="clearfix"></div>
                    <div class="form-group">
                      <div>
                        {% bootstrap_field postForm.barcode %}
                      </div>
                    </div>
                    <div class="clearfix"></div>
                    <div class="form-group">
                    <div class="row">
                      <div class="col-md-6 col-xs-12 mb-10">
                          <div>
                            {% bootstrap_field postForm.price %}
                            <small class="text-muted">Currency: {{ shop_currency }} | Unit: {{ shop_weight_unit }}</small>
                          </div>
                        </div>
                        <div class="col-md-6 col-xs-12 mb-10">
                          <div >
                            {% bootstrap_field postForm.discount_price %}
                          </div>
                        </div>
                    </div>
                    </div>
                    <div class="clearfix"></div>
                    <div class="form-group">
                    <div class="row">
                        <div class="col-md-6 col-xs-12 mb-10">
                          <div >
                            {% bootstrap_field postForm.status %}
                          </div>
                        </div>
                        <div class="col-md-6 col-xs-12 mb-10">
                          <div >
                            {% bootstrap_field postForm.label %}
                          </div>
                        </div>
                     </div>
                    </div>
                    <div class="clearfix"></div>

                    <div class="card-body">
                      <h4 class="font-18 text-blue text-uppercase mb-20">Upload More Photos</h4>
                      <div class="upload-dropzone border border-dashed p-4 text-center mb-3" id="imageDropzone">
                        <p class="mb-1">Drag and drop images here or click to browse.</p>
                        <small class="text-muted">You can upload multiple images at once.</small>
                        <input type="file" name="product_images" id="productImages" class="form-control mt-3" multiple>
                      </div>
                      <div id="imagePreviewList" class="row"></div>
                      <div class="modal fade" id="cropperModal" tabindex="-1" role="dialog" aria-hidden="true">
                        <div class="modal-dialog modal-lg" role="document">
                          <div class="modal-content">
                            <div class="modal-header">
                              <h5 class="modal-title">Crop image</h5>
                              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                              </button>
                            </div>
                            <div class="modal-body">
                              <img id="cropperImage" src="" alt="Cropper preview" class="img-fluid">
                            </div>
                            <div class="modal-footer">
                              <button type="button" class="btn btn-outline-secondary" data-dismiss="modal">Cancel</button>
                              <button type="button" class="btn btn-primary" id="applyCrop">Apply Crop</button>
                            </div>
                          </div>
                        </div>
                      </div>
                      {% if product %}
                        <div class="row">
                          {% for image in product.images.all %}
                            <div class="col-md-3 mb-2">
                              <div class="border rounded p-2 text-center">
                                <img src="{{ image.product_image.url }}" alt="{{ product.title }}" class="img-fluid rounded mb-2">
                                <div class="form-check mb-2">
                                  <input class="form-check-input" type="checkbox" name="delete_image_ids" value="{{ image.id }}" id="deleteImage{{ image.id }}">
                                  <label class="form-check-label" for="deleteImage{{ image.id }}">Remove</label>
                                </div>
                                <div class="form-group mb-0">
                                  <label class="font-12" for="replaceImage{{ image.id }}">Replace image</label>
                                  <input type="file" class="form-control" name="replace_image_{{ image.id }}" id="replaceImage{{ image.id }}">
                                </div>
                              </div>
                            </div>
                          {% endfor %}
                        </div>
                      {% endif %}
                    </div>

                    <div class="form-group row mb-0">
                      <div class="col-sm-12 p-0">
                        <div class="col-12">
                          {% bootstrap_field postForm.description %}
                        </div>
                      </div>
                    </div>
                    <div class="card">
                    <div class="card-body">
                      <div id="formErrors" class="alert alert-danger d-none"></div>
                      <div class="row">
                        <div class="col-md-6 col-xs-12 mb-10">
                          <div>
                            {% bootstrap_field postForm.delivery %}
                          </div>
                        </div>
                        <div class="col-md-6 col-sm-6 mb-20">
                          <label class="switch">
                            {% bootstrap_field postForm.available %}
                            <span class="slider"></span> </label>
                          <span class="font-14"></span> </div>
                        <div class="col-md-6 col-sm-6 text-right">
                          <div class="5">
                            <button type="submit" class="btn btn-rounded waves-effect waves-light bg-green font-14 text-white">Save</button>
                            <button type="submit" name="save_draft" value="1" class="btn btn-rounded waves-effect waves-light btn-outline-primary font-14">Save as Draft</button>
                            <button type="button" class="btn btn-rounded waves-effect waves-light btn-outline-default font-14"><a href="{% url 'home:home' %}">Cancel</a></button>
                          </div>
                        </div>
                      </div>
                    </div>
                    </div>
                  </form>
                  {% if product %}
                    <form method="post" action="{% url 'foodcreate:duplicate_product' product.id %}" class="mt-3">
                      {% csrf_token %}
                      <button type="submit" class="btn btn-outline-secondary btn-sm">Duplicate this product</button>
                    </form>
                  {% endif %}
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

    </div>


    {% block script %}
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cropperjs@1.6.2/dist/cropper.min.css">
        {{ categories|json_script:"category-data" }}
        <script src="https://cdn.jsdelivr.net/npm/cropperjs@1.6.2/dist/cropper.min.js"></script>
        <script>
            $("#id_category").change(function () {
              var url = $("#post_form").attr("data-cities-url");  // get the url of the `load_cities` view
              var categoryId = $(this).val();  // get the selected country ID from the HTML input

              $.ajax({                       // initialize an AJAX request
                url: url,                    // set the url of the request (= localhost:8000/hr/ajax/load-cities/)
                data: {
                  'category': categoryId       // add the country id to the GET parameters
                },
                success: function (data) {   // `data` is the return of the `load_cities` view function
                  $("#id_subcategory").html(data);  // replace the contents of the city input with the data that came from the server
                }
              });

            });

            const progressBar = $("#onboardingProgress");
            const requiredFields = ["#id_title", "#id_category", "#id_price", "#id_description", "#productImages"];

            function updateProgress() {
              let completed = 0;
              requiredFields.forEach((selector) => {
                const field = $(selector);
                if (field.length && field.val()) {
                  completed += 1;
                }
              });
              const percentage = Math.round((completed / requiredFields.length) * 100);
              progressBar.css("width", percentage + "%");
            }

            $("#id_title, #id_category, #id_price, #id_description, #productImages").on("change keyup", updateProgress);
            updateProgress();

            const dropzone = document.getElementById("imageDropzone");
            const imageInput = document.getElementById("productImages");
            const previewList = document.getElementById("imagePreviewList");
            const cropperModal = $("#cropperModal");
            const cropperImage = document.getElementById("cropperImage");
            const applyCropButton = document.getElementById("applyCrop");
            let cropper = null;
            let currentCropIndex = null;
            let processedFiles = [];

            if (dropzone && imageInput) {
              dropzone.addEventListener("click", () => imageInput.click());
              dropzone.addEventListener("dragover", (event) => {
                event.preventDefault();
                dropzone.classList.add("bg-light");
              });
              dropzone.addEventListener("dragleave", () => dropzone.classList.remove("bg-light"));
              dropzone.addEventListener("drop", (event) => {
                event.preventDefault();
                dropzone.classList.remove("bg-light");
                if (event.dataTransfer.files.length) {
                  imageInput.files = event.dataTransfer.files;
                  handleFileSelection(event.dataTransfer.files);
                  updateProgress();
                }
              });
            }

            function resizeImage(file, maxSize = 1200) {
              return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = function (event) {
                  const img = new Image();
                  img.onload = function () {
                    const canvas = document.createElement("canvas");
                    let width = img.width;
                    let height = img.height;
                    if (width > height && width > maxSize) {
                      height *= maxSize / width;
                      width = maxSize;
                    } else if (height > maxSize) {
                      width *= maxSize / height;
                      height = maxSize;
                    }
                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext("2d");
                    ctx.drawImage(img, 0, 0, width, height);
                    canvas.toBlob((blob) => {
                      const resizedFile = new File([blob], file.name, { type: "image/jpeg" });
                      resolve(resizedFile);
                    }, "image/jpeg", 0.85);
                  };
                  img.src = event.target.result;
                };
                reader.readAsDataURL(file);
              });
            }

            function updateInputFiles() {
              const dataTransfer = new DataTransfer();
              processedFiles.forEach((file) => dataTransfer.items.add(file));
              imageInput.files = dataTransfer.files;
            }

            function renderPreview() {
              previewList.innerHTML = "";
              processedFiles.forEach((file, index) => {
                const col = document.createElement("div");
                col.className = "col-md-3 mb-2";
                const card = document.createElement("div");
                card.className = "border rounded p-2 text-center";
                const img = document.createElement("img");
                img.className = "img-fluid rounded mb-2";
                img.alt = file.name;
                img.src = URL.createObjectURL(file);
                const cropButton = document.createElement("button");
                cropButton.type = "button";
                cropButton.className = "btn btn-outline-secondary btn-sm";
                cropButton.textContent = "Crop";
                cropButton.addEventListener("click", () => openCropper(index));
                card.appendChild(img);
                card.appendChild(cropButton);
                col.appendChild(card);
                previewList.appendChild(col);
              });
            }

            async function handleFileSelection(files) {
              processedFiles = [];
              for (const file of files) {
                if (!file.type.startsWith("image/")) {
                  continue;
                }
                const resized = await resizeImage(file);
                processedFiles.push(resized);
              }
              updateInputFiles();
              renderPreview();
            }

            if (imageInput) {
              imageInput.addEventListener("change", (event) => {
                handleFileSelection(event.target.files);
              });
            }

            function openCropper(index) {
              currentCropIndex = index;
              const file = processedFiles[index];
              if (!file) {
                return;
              }
              cropperImage.src = URL.createObjectURL(file);
              cropperModal.modal("show");
              cropperModal.on("shown.bs.modal", function () {
                if (cropper) {
                  cropper.destroy();
                }
                cropper = new Cropper(cropperImage, {
                  viewMode: 1,
                  autoCropArea: 1,
                  movable: true,
                  zoomable: true,
                  scalable: true,
                  background: false,
                });
              });
            }

            if (applyCropButton) {
              applyCropButton.addEventListener("click", () => {
                if (!cropper || currentCropIndex === null) {
                  cropperModal.modal("hide");
                  return;
                }
                const canvas = cropper.getCroppedCanvas({ width: 1200, height: 1200 });
                canvas.toBlob((blob) => {
                  const original = processedFiles[currentCropIndex];
                  const croppedFile = new File([blob], original.name, { type: "image/jpeg" });
                  processedFiles[currentCropIndex] = croppedFile;
                  updateInputFiles();
                  renderPreview();
                  cropper.destroy();
                  cropper = null;
                  cropperModal.modal("hide");
                }, "image/jpeg", 0.9);
              });
            }

            $("#templateProduct").change(function () {
              const templateId = $(this).val();
              if (!templateId) {
                return;
              }
              $.get("{% url 'foodcreate:lookup_product' %}", { template_id: templateId }, function (data) {
                if (!data.found) {
                  return;
                }
                $("#id_title").val(data.title);
                $("#id_category").val(data.category).trigger("change");
                setTimeout(function () {
                  $("#id_subcategory").val(data.subcategory);
                }, 300);
                $("#id_price").val(data.price);
                $("#id_discount_price").val(data.discount_price);
                $("#id_description").val(data.description);
                $("#id_label").val(data.label);
                $("#id_status").val(data.status);
                $("#id_delivery").val(data.delivery);
                $("#id_available").prop("checked", data.available);
                $("#id_barcode").val(data.barcode);
                updateProgress();
              });
            });

            $("#id_barcode").on("blur", function () {
              const barcode = $(this).val();
              if (!barcode) {
                return;
              }
              $.get("{% url 'foodcreate:lookup_product' %}", { barcode: barcode }, function (data) {
                if (!data.found) {
                  return;
                }
                if (!$("#id_title").val()) {
                  $("#id_title").val(data.title);
                }
                if (!$("#id_price").val()) {
                  $("#id_price").val(data.price);
                }
                if (!$("#id_description").val()) {
                  $("#id_description").val(data.description);
                }
                if (!$("#id_category").val()) {
                  $("#id_category").val(data.category).trigger("change");
                  setTimeout(function () {
                    $("#id_subcategory").val(data.subcategory);
                  }, 300);
                }
                updateProgress();
              });
            });

            const categoryDataElement = document.getElementById("category-data");
            const categoryData = categoryDataElement ? JSON.parse(categoryDataElement.textContent || "[]") : [];
            function suggestCategoryFromText() {
              const title = $("#id_title").val().toLowerCase();
              const description = $("#id_description").val().toLowerCase();
              if ($("#id_category").val()) {
                return;
              }
              const match = categoryData.find((category) => {
                const name = category.name.toLowerCase();
                return title.includes(name) || description.includes(name);
              });
              if (match) {
                $("#id_category").val(match.id).trigger("change");
              }
            }

            $("#id_title, #id_description").on("blur keyup", suggestCategoryFromText);

            const formErrors = document.getElementById("formErrors");
            function showErrors(errors) {
              if (!formErrors) {
                return;
              }
              if (!errors.length) {
                formErrors.classList.add("d-none");
                formErrors.innerHTML = "";
                return;
              }
              formErrors.classList.remove("d-none");
              formErrors.innerHTML = "<ul class='mb-0'>" + errors.map((err) => `<li>${err}</li>`).join("") + "</ul>";
            }

            $("#post_form").on("submit", function (event) {
              const errors = [];
              const title = $("#id_title").val();
              const category = $("#id_category").val();
              const price = parseFloat($("#id_price").val());
              const discount = parseFloat($("#id_discount_price").val());
              const description = $("#id_description").val();
              if (!title) errors.push("Title is required.");
              if (!category) errors.push("Category is required.");
              if (!description) errors.push("Description is required.");
              if (Number.isNaN(price) || price <= 0) errors.push("Price must be a positive number.");
              if (!Number.isNaN(discount) && discount > price) errors.push("Discount price cannot exceed price.");
              const existingImages = parseInt($("#post_form").data("existing-images") || "0", 10);
              if (imageInput && !imageInput.files.length && existingImages === 0) {
                errors.push("At least one product image is required.");
              }
              showErrors(errors);
              if (errors.length) {
                event.preventDefault();
                $("html, body").animate({ scrollTop: 0 }, "slow");
              }
            });
          </script>
    {% endblock %}


{% endblock %}
