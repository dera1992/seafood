{% extends "base.html" %}
{% load humanize %}

{% block title %}Shopping Budget{% endblock %}

{% block content %}
<div class="breadcrumb-area mb-50">
    <div class="container">
        <div class="row">
            <div class="col">
                <div class="breadcrumb-container">
                    <ul>
                        <li><a href="{% url "home:home" %}"><i class="fa fa-home"></i> Home</a></li>
                        <li class="active">Shopping Budget Planner</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="page-section section mb-50">
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-12">
                <div class="cart-summary mb-40">
                    <div class="cart-summary-wrap">
                        <h4>Budget overview</h4>
                        <p>Total budget <span>£{{ budget.total_budget|intcomma }}</span></p>
                        <p>Planned spend <span>£{{ budget.current_spent|intcomma }}</span></p>
                        <p>Remaining <span>£{{ budget.remaining_budget|intcomma }}</span></p>
                        {% if budget.remaining_budget < 0 %}
                            <p class="text-danger">Warning: You have exceeded your budget by £{{ budget.remaining_budget|intcomma|slice:"1:" }}.</p>
                        {% endif %}
                    </div>
                    <div class="cart-summary-button">
                        <a class="btn btn-secondary" href="{% url 'budget:duplicate-budget' budget.id %}">Duplicate Budget</a>
                        <a class="btn btn-secondary" href="{% url 'budget:add-from-cart' budget.id %}">Add Items From Cart</a>
                        <a class="btn btn-secondary" href="{% url 'order:checkout' %}?budget={{ budget.id }}">
                            Proceed to Checkout
                        </a>
                    </div>
                </div>

                <div class="cart-summary mb-40">
                    <div class="cart-summary-wrap">
                        <h4>Add products to your shopping list</h4>
                        <form method="post" action="{% url 'budget:add-item' budget.id %}">
                            {% csrf_token %}
                            <datalist id="product-options"></datalist>
                            <div class="row">
                                <div class="col-md-5 col-12 mb-25">
                                    <label for="add-product-input">Product</label>
                                    <input
                                        id="add-product-input"
                                        class="form-control"
                                        type="text"
                                        data-product-input="id_product"
                                        data-name-input="id_name"
                                        data-product-datalist="add-product-options"
                                        placeholder="Search products or enter a custom item"
                                        autocomplete="off"
                                        list="add-product-options"
                                    />
                                    <datalist id="add-product-options"></datalist>
                                    <div class="d-none">
                                        {{ add_form.product }}
                                    </div>
                                </div>
                                <div class="col-md-4 col-12 mb-25">
                                    {{ add_form.name.as_hidden }}
                                </div>
                                <div class="col-md-3 col-12 mb-25">
                                    {{ add_form.quantity.label_tag }}
                                    {{ add_form.quantity }}
                                </div>
                                <div class="col-md-12 col-12 mb-25 d-flex align-items-end">
                                    <button class="btn btn-secondary" type="submit">Add</button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>

                <div class="cart-summary">
                    <div class="cart-summary-wrap">
                        <div class="d-flex justify-content-between align-items-center mb-20">
                            <h4 class="mb-0">Your shopping list</h4>
                            <a class="btn btn-secondary btn-sm" href="{% url 'order:checkout' %}?budget={{ budget.id }}">
                                Proceed to Checkout
                            </a>
                        </div>
                        <div class="cart-table table-responsive">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Product</th>
                                        <th>Unit Price</th>
                                        <th>Quantity</th>
                                        <th>Total</th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody>
                                {% for item in items %}
                                    <tr data-item-row="{{ item.id }}">
                                        <td>
                                            {% if item.product %}
                                                {{ item.product.title }}
                                            {% else %}
                                                {{ item.name|default:"Custom item" }}
                                                <span class="badge bg-warning text-dark ms-2">Unmatched</span>
                                                {% if item.suggestions %}
                                                    <div class="text-muted small mt-1">Suggestions:</div>
                                                    <ul class="list-unstyled small mb-0">
                                                        {% for suggestion in item.suggestions %}
                                                            <li>{{ suggestion.title }}</li>
                                                        {% endfor %}
                                                    </ul>
                                                {% endif %}
                                            {% endif %}
                                        </td>
                                        <td data-unit-price>£{{ item.unit_price|intcomma }}</td>
                                        <td>
                                            <form
                                                method="post"
                                                action="{% url 'budget:update-item-quantity' budget.id item.id %}"
                                                class="d-flex align-items-center gap-2 js-quantity-form"
                                                data-item-id="{{ item.id }}"
                                            >
                                                {% csrf_token %}
                                                <input
                                                    type="number"
                                                    name="quantity"
                                                    class="form-control form-control-sm shopping-qty-input"
                                                    min="1"
                                                    value="{{ item.quantity|default:1 }}"
                                                    inputmode="numeric"
                                                    aria-label="Quantity"
                                                />
                                                <button class="btn btn-sm btn-outline-secondary" type="submit">Update</button>
                                            </form>
                                        </td>
                                        <td data-total-cost>£{{ item.total_cost|intcomma }}</td>
                                        <td>
                                            {% if item.product %}
                                                <a
                                                    class="btn btn-sm btn-outline-secondary me-2 js-product-modal"
                                                    href="{{ item.product.get_absolute_url }}"
                                                    data-product-url="{% url 'home:ad_preview' item.product.id item.product.slug %}"
                                                    data-toggle="modal"
                                                    data-target="#productPreviewModal"
                                                    aria-label="View product"
                                                >
                                                    <i class="fa fa-eye"></i>
                                                </a>
                                            {% endif %}
                                            <a class="btn btn-sm btn-outline-secondary me-2" href="{% url 'budget:edit-item' budget.id item.id %}" aria-label="Edit item">
                                                <i class="fa fa-pencil"></i>
                                            </a>
                                            <a href="{% url 'budget:remove-item' budget.id item.id %}"><i class="fa fa-trash-o"></i></a>
                                        </td>
                                    </tr>
                                    <div class="modal fade" id="editItemModal-{{ item.id }}" tabindex="-1" aria-hidden="true">
                                        <div class="modal-dialog">
                                            <div class="modal-content">
                                                <form method="post" action="{% url 'budget:edit-item' budget.id item.id %}">
                                                    {% csrf_token %}
                                                    <div class="modal-header">
                                                        <h5 class="modal-title">Edit shopping list item</h5>
                                                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                                    </div>
                                                    <div class="modal-body">
                                                        <div class="mb-3">
                                                            <label for="edit-product-name-{{ item.id }}">Product</label>
                                                            <input
                                                                id="edit-product-name-{{ item.id }}"
                                                                class="form-control"
                                                                name="product_name"
                                                                type="text"
                                                                list="product-options"
                                                                value="{{ item.edit_form.product_name.value|default_if_none:'' }}"
                                                                data-product-autocomplete
                                                                data-product-id-target="edit-product-id-{{ item.id }}"
                                                                placeholder="Start typing a product"
                                                            />
                                                            <input
                                                                id="edit-product-id-{{ item.id }}"
                                                                name="product_id"
                                                                type="hidden"
                                                                value="{{ item.edit_form.product_id.value|default_if_none:'' }}"
                                                            />
                                                            {{ item.edit_form.product }}
                                                        </div>
                                                        <div class="mb-3">
                                                            {{ item.edit_form.name.label_tag }}
                                                            {{ item.edit_form.name }}
                                                        </div>
                                                        <div class="mb-3">
                                                            {{ item.edit_form.quantity.label_tag }}
                                                            {{ item.edit_form.quantity }}
                                                        </div>
                                                    </div>
                                                    <div class="modal-footer">
                                                        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                                                        <button class="btn btn-secondary" type="submit">Save</button>
                                                    </div>
                                                </form>
                                            </div>
                                        </div>
                                    </div>
                                {% empty %}
                                    <tr>
                                        <td colspan="5" class="text-center">No items yet. Add products to start planning.</td>
                                    </tr>
                                {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-4 col-12">
                <div class="cart-summary mb-40">
                    <div class="cart-summary-wrap">
                        <h4>Budget breakdown</h4>
                        {% if category_totals %}
                            {% for category, total in category_totals.items %}
                                <p>{{ category }} <span>£{{ total|intcomma }}</span></p>
                            {% endfor %}
                        {% else %}
                            <p class="text-muted">Add items to see category totals.</p>
                        {% endif %}
                    </div>
                </div>

                <div class="cart-summary mb-40">
                    <div class="cart-summary-wrap">
                        <h4>Budget-friendly offers</h4>
                        {% if discounted_items %}
                            {% if affordable_discounts %}
                                <ul class="list-unstyled">
                                    {% for item in affordable_discounts %}
                                        <li class="mb-10">{{ item.product.title }} • £{{ item.total_cost|intcomma }}</li>
                                    {% endfor %}
                                </ul>
                            {% else %}
                                <p class="text-muted">Discounted items are selected, but they exceed your remaining budget.</p>
                            {% endif %}
                        {% else %}
                            <p class="text-muted">No discounted items yet. Add promotions to save more.</p>
                        {% endif %}
                    </div>
                </div>

                <div class="cart-summary mb-40">
                    <div class="cart-summary-wrap">
                        <h4>Discount suggestions within your budget</h4>
                        {% if suggested_discounts %}
                            <ul class="list-unstyled">
                                {% for product in suggested_discounts %}
                                    <li class="mb-10">
                                        <a href="{{ product.get_absolute_url }}">{{ product.title }}</a>
                                        <span>£{{ product.discount_price|intcomma }}</span>
                                    </li>
                                {% endfor %}
                            </ul>
                        {% else %}
                            <p class="text-muted">We will suggest discounted items once your remaining budget is above £0.</p>
                        {% endif %}
                    </div>
                </div>

                <div class="cart-summary mb-40">
                    <div class="cart-summary-wrap">
                        <h4>Reusable templates</h4>
                        <form method="post" action="{% url 'budget:create-template' budget.id %}">
                            {% csrf_token %}
                            <div class="row">
                                <div class="col-md-8 col-12 mb-25">
                                    {{ template_form.name.label_tag }}
                                    {{ template_form.name }}
                                </div>
                                <div class="col-md-4 col-12 mb-25 d-flex align-items-end">
                                    <button class="btn btn-secondary" type="submit">Save Template</button>
                                </div>
                            </div>
                        </form>
                        {% if templates %}
                            <ul class="list-unstyled">
                                {% for saved_template in templates %}
                                    <li class="mb-10">
                                        <a href="{% url 'budget:view-template' saved_template.id %}">{{ saved_template.name }}</a>
                                        <a class="ml-2" href="{% url 'budget:apply-template' budget.id saved_template.id %}">Apply</a>
                                    </li>
                                {% endfor %}
                            </ul>
                        {% else %}
                            <p class="text-muted">Save a template to reuse this plan in the future.</p>
                        {% endif %}
                    </div>
                </div>

                <div class="cart-summary mb-40">
                    <div class="cart-summary-wrap">
                        <h4>AI-driven budget insights</h4>
                        {% if price_predictions %}
                            <p class="mb-10">Price predictions</p>
                            <ul class="list-unstyled">
                                {% for prediction in price_predictions %}
                                    <li class="mb-10">
                                        {{ prediction.product.title }} — {{ prediction.message }}
                                    </li>
                                {% endfor %}
                            </ul>
                        {% endif %}
                        {% if savings_suggestions %}
                            <p class="mb-10">Savings suggestions</p>
                            <ul class="list-unstyled">
                                {% for product, alternatives in savings_suggestions.items %}
                                    {% if alternatives %}
                                        <li class="mb-10">
                                            Alternatives for {{ product.title }}:
                                            <ul class="list-unstyled ml-3">
                                                {% for alternative in alternatives %}
                                                    <li>
                                                        <a href="{{ alternative.get_absolute_url }}">{{ alternative.title }}</a>
                                                        <span>£{{ alternative.discount_price|default:alternative.price|intcomma }}</span>
                                                    </li>
                                                {% endfor %}
                                            </ul>
                                        </li>
                                    {% endif %}
                                {% endfor %}
                            </ul>
                        {% else %}
                            <p class="text-muted">Add items to your budget to see AI-powered insights.</p>
                        {% endif %}
                    </div>
                </div>

                <div class="cart-summary">
                    <div class="cart-summary-wrap">
                        <h4>Saved budgets</h4>
                        <ul class="list-unstyled">
                            {% for saved_budget in budgets %}
                                <li class="mb-10">
                                    <a href="{% url 'budget:view-budget' saved_budget.id %}">
                                        Budget £{{ saved_budget.total_budget|intcomma }}
                                    </a>
                                    <small class="text-muted">
                                        (Spent £{{ saved_budget.current_spent|intcomma }}, Remaining £{{ saved_budget.remaining_budget|intcomma }})
                                    </small>
                                    <small class="text-muted d-block">{{ saved_budget.created_at|date:"M d, Y" }}</small>
                                </li>
                            {% endfor %}
                        </ul>
                        <a class="btn btn-secondary" href="{% url 'budget:set-budget' %}">Create a new budget</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<div
    class="modal fade"
    id="productPreviewModal"
    tabindex="-1"
    role="dialog"
    aria-labelledby="productPreviewLabel"
    aria-hidden="true"
>
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="productPreviewLabel">Product preview</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body p-4">
                <div id="productPreviewContent">
                    <p class="text-muted mb-0">Loading product preview...</p>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
    (function () {
        document.querySelectorAll("[data-product-input]").forEach((input) => {
            const select = document.getElementById(input.dataset.productInput);
            const nameInput = document.getElementById(input.dataset.nameInput);
            const datalist = document.getElementById(input.dataset.productDatalist);
            if (!select || !datalist) {
                return;
            }
            const options = Array.from(select.options)
                .filter((option) => option.value)
                .map((option) => ({
                    value: option.value,
                    text: option.text.trim(),
                }));
            datalist.innerHTML = "";
            options.forEach((option) => {
                const entry = document.createElement("option");
                entry.value = option.text;
                datalist.appendChild(entry);
            });

            const syncFromInput = () => {
                const query = input.value.trim();
                const match = options.find(
                    (option) => option.text.toLowerCase() === query.toLowerCase(),
                );
                if (match) {
                    select.value = match.value;
                    if (nameInput) {
                        nameInput.value = "";
                    }
                } else {
                    select.value = "";
                    if (nameInput) {
                        nameInput.value = query;
                    }
                }
            };

            const selectedOption = select.options[select.selectedIndex];
            if (selectedOption && selectedOption.value) {
                input.value = selectedOption.text.trim();
            } else if (nameInput && nameInput.value) {
                input.value = nameInput.value;
            }

            input.addEventListener("input", syncFromInput);
            input.addEventListener("change", syncFromInput);
        });

        const modalTriggers = document.querySelectorAll(".js-product-modal");
        const previewContent = document.getElementById("productPreviewContent");
        modalTriggers.forEach((trigger) => {
            trigger.addEventListener("click", async () => {
                if (!previewContent) {
                    return;
                }
                previewContent.innerHTML = "<p class=\"text-muted mb-0\">Loading product preview...</p>";
                const previewUrl = trigger.dataset.productUrl || trigger.href;
                try {
                    const response = await fetch(previewUrl, {
                        headers: {
                            "X-Requested-With": "XMLHttpRequest",
                        },
                    });
                    if (!response.ok) {
                        throw new Error("Preview failed");
                    }
                    previewContent.innerHTML = await response.text();
                } catch (error) {
                    previewContent.innerHTML = `
                        <p class="text-danger">Unable to load product preview.</p>
                        <a class="btn btn-outline-secondary" href="${trigger.href}">View full product page</a>
                    `;
                }
            });
        });

        const formatCurrency = (value) => {
            const numberValue = Number.parseFloat(value);
            if (Number.isNaN(numberValue)) {
                return value;
            }
            return new Intl.NumberFormat("en-GB", {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2,
            }).format(numberValue);
        };

        document.querySelectorAll(".js-quantity-form").forEach((form) => {
            form.addEventListener("submit", async (event) => {
                event.preventDefault();
                const formData = new FormData(form);
                const response = await fetch(form.action, {
                    method: "POST",
                    headers: {
                        "X-Requested-With": "XMLHttpRequest",
                    },
                    body: formData,
                });

                if (!response.ok) {
                    window.alert("Unable to update quantity. Please try again.");
                    return;
                }

                const data = await response.json();
                const row = form.closest("[data-item-row]");
                if (row) {
                    const totalCell = row.querySelector("[data-total-cost]");
                    if (totalCell) {
                        totalCell.textContent = `£${formatCurrency(data.total_cost)}`;
                    }
                }
            });
        });

        const previewModal = document.getElementById("productPreviewModal");
        if (previewModal && previewContent) {
            previewModal.addEventListener("hidden.bs.modal", () => {
                previewContent.innerHTML = "<p class=\"text-muted mb-0\">Loading product preview...</p>";
            });
        }
    })();
</script>
{% endblock %}
