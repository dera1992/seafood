{% extends "base.html" %}
{% load static %}

{% block content %}
<section class="container py-5">
    <h1 class="mb-3">Voice Budget Planner</h1>
    <p class="text-muted">Try ‚ÄúI have 25 pounds, help me buy rice, tomatoes and fish‚Äù.</p>

    <div class="mb-3">
        <button id="voice-mic" class="btn btn-primary" type="button">üé§ Start Listening</button>
        <span id="voice-status" class="ms-3 text-muted"></span>
    </div>

    <div class="mb-3">
        <label for="voice-text" class="form-label">Type your request</label>
        <input id="voice-text" class="form-control" type="text" placeholder="Budget 20 pounds for rice and fish" />
    </div>

    <button id="voice-submit" class="btn btn-outline-secondary" type="button">Plan Budget</button>

    <div class="mt-4">
        <p id="assistant-message" class="fw-semibold"></p>
        <div id="bundle-results" class="row g-3"></div>
    </div>
</section>

<script>
    const micButton = document.getElementById("voice-mic");
    const submitButton = document.getElementById("voice-submit");
    const textInput = document.getElementById("voice-text");
    const statusText = document.getElementById("voice-status");
    const assistantMessage = document.getElementById("assistant-message");
    const resultsContainer = document.getElementById("bundle-results");

    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    const recognition = SpeechRecognition ? new SpeechRecognition() : null;

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    function renderBundles(bundles) {
        resultsContainer.innerHTML = "";
        if (!bundles.length) {
            return;
        }
        bundles.forEach(bundle => {
            const card = document.createElement("div");
            card.className = "col-md-6";
            const itemsHtml = bundle.items.map(item => `
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    <span>${item.title}</span>
                    <span>¬£${item.price.toFixed(2)}</span>
                </li>
            `).join('');

            card.innerHTML = `
                <div class="card h-100">
                    <div class="card-body">
                        <h5 class="card-title">Bundle total: ¬£${bundle.total.toFixed(2)}</h5>
                        <ul class="list-group list-group-flush">${itemsHtml}</ul>
                    </div>
                </div>
            `;
            resultsContainer.appendChild(card);
        });
    }

    function sendVoiceText(text) {
        if (!text) {
            assistantMessage.textContent = "Please say or type your budget request.";
            return;
        }
        assistantMessage.textContent = "";
        resultsContainer.innerHTML = "";
        fetch("/voice/interpret/", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": getCookie("csrftoken")
            },
            body: JSON.stringify({ text, prefer_rules: true, mode: "budget" })
        })
        .then(response => response.json())
        .then(data => {
            assistantMessage.textContent = data.assistant_message || "";
            if (data.budget_url) {
                window.location.assign(data.budget_url);
                return;
            }
            if (data.intent === "BUDGET_PLAN") {
                renderBundles((data.results && data.results.bundles) || []);
            }
        })
        .catch(() => {
            assistantMessage.textContent = "Something went wrong. Please try again.";
        });
    }

    if (!recognition) {
        statusText.textContent = "Speech recognition is not supported. Use the text box instead.";
    } else {
        recognition.lang = "en-GB";
        recognition.interimResults = false;
        recognition.maxAlternatives = 1;

        recognition.addEventListener("start", () => {
            statusText.textContent = "Listening...";
        });
        recognition.addEventListener("end", () => {
            statusText.textContent = "";
        });
        recognition.addEventListener("result", (event) => {
            const transcript = event.results[0][0].transcript;
            textInput.value = transcript;
            sendVoiceText(transcript);
        });

        micButton.addEventListener("click", () => {
            recognition.start();
        });
    }

    submitButton.addEventListener("click", () => {
        sendVoiceText(textInput.value);
    });
</script>
{% endblock %}
