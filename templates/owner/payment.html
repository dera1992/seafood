{% extends "base.html" %}
{% load static %}
{% load django_bootstrap5 %}
{% load i18n %}
{% load thumbnail %}
{% load humanize %}

{% block title %}Payment{% endblock %}

{% block content %}
  <div class="grid gap-6 lg:grid-cols-3">
    <div class="lg:col-span-2 bg-white rounded-xl shadow p-6 text-center space-y-4">
      <h2 class="text-xl font-semibold text-gray-900">Make payment</h2>
      <p class="text-sm text-gray-500">Complete your payment for <span class="font-semibold text-gray-900">£{{ amt|intcomma }}</span>.</p>
      <script src="https://js.paystack.co/v1/inline.js"></script>
      <button class="rounded-lg bg-emerald-600 px-6 py-2 text-sm font-semibold text-white hover:bg-emerald-700" onclick="payWithPayStack()" id="django-paystack-button">Pay with Paystack</button>
    </div>

    <div class="bg-white rounded-xl shadow p-6">
      <h3 class="text-lg font-semibold text-gray-900">Cart total</h3>
      <div class="mt-4 space-y-3 text-sm text-gray-600">
        <ul class="space-y-2">
          {% for order_item in order.items.all %}
            <li class="flex justify-between gap-4">
              <span>{{ order_item.item.title }} × {{ order_item.quantity }}</span>
              {% if order_item.item.discount_price %}
                <span>£{{ order_item.get_total_discount_item_price|intcomma }}</span>
              {% else %}
                <span>£{{ order_item.get_total_item_price|intcomma }}</span>
              {% endif %}
            </li>
          {% endfor %}
        </ul>

        {% for order_item in order.items.all %}
          <p class="flex justify-between"><span>Sub total</span><span>£{{ order_item.get_final_price|intcomma }}</span></p>
        {% endfor %}
        <p class="flex justify-between"><span>Shipping fee</span><span>£00.00</span></p>
        {% if order.coupon %}
          <p class="flex justify-between"><span>Promo code ({{ order.coupon.code }})</span><span>-£{{ order.coupon.amount|intcomma }}</span></p>
        {% endif %}
        <p class="flex justify-between text-base font-semibold text-gray-900"><span>Grand total</span><span>£{{ order.get_total|intcomma }}</span></p>
      </div>
    </div>
  </div>

  <script>
    function payWithPayStack() {
      let currency = "NGN";
      let plan = "";
      let ref = "{{ order.ref }}";
      let obj ={
        key: "{{ paystack_public_key }}",
        email:'{{ order.user.email }}',
        amount:'{{ amount }}',
        ref:ref,
        callback:function (response) {
          window.location.href = "{% url 'order:verify_payment' order.ref %}";
        }
      }

      if (Boolean(currency)) {
        obj.currency = currency.toUpperCase()
      }

      if (Boolean(plan)){
        obj.plan = plan;
      }
      var handler = PaystackPop.setup(obj);
      handler.openIframe();
    }
  </script>
{% endblock %}
